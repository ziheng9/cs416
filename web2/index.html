<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rising Temperatures: A Climate Story</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background-color: #f5f5f5; }
    .container { max-width: 960px; margin: auto; padding: 20px; }
    h1, .subtitle { text-align: center; margin: 0; }
    .subtitle { color: #555; margin-bottom: 20px; font-size: 1.1rem; }
    svg { width: 100%; height: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navigation { text-align: center; margin: 15px 0; }
    button { background: #4CAF50; color: #fff; border: none; padding: 10px 20px; margin: 0 5px; font-size: 1rem; border-radius: 4px; cursor: pointer; transition: background .2s; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .scene-indicator { text-align: center; color: #666; margin: 5px 0; }
    .tooltip { position: absolute; padding: 8px; background: rgba(0,0,0,0.8); color: #fff; border-radius: 4px; pointer-events: none; font-size: 0.85rem; opacity: 0; transition: opacity 0.2s; }
    .annotation-note-title { font-weight: bold; }
    .annotation-note-label { font-size: 0.85rem; }
    .interactive-note { text-align: center; font-style: italic; color: #666; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Rising Temperatures: A Climate Story</h1>
    <p class="subtitle">Global Temperature Anomalies from 1880 to 2023</p>
    <div id="chart"></div>
    <div class="scene-indicator" id="sceneIndicator">Loading...</div>
    <div class="navigation">
      <button id="prevBtn">Previous</button>
      <button id="nextBtn">Next</button>
    </div>
    <p class="interactive-note" id="interactiveNote" style="display:none;">Hover over points to see details</p>
  </div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    // Margins and dimensions
    const margin = { top: 30, right: 40, bottom: 50, left: 60 };
    const width = 960 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    // State
    let data = [];
    let currentScene = 0;

    // Scales (domains set after data load)
    const x = d3.scaleLinear().range([0, width]);
    const y = d3.scaleLinear().range([height, 0]);
    const color = d3.scaleSequential().interpolator(d3.interpolateRdYlBu).clamp(true);

    // Line generator
    const lineGen = d3.line()
      .x(d => x(d.year))
      .y(d => y(d.temperature))
      .curve(d3.curveMonotoneX);

    // SVG container
    const svg = d3.select('#chart')
      .append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
      .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    // Tooltip
    const tooltip = d3.select('#tooltip');

    // Scenes definition
    const scenes = [
      { label: 'Early Industrial Era', endYear: 1950, interactive: false,
        annotation: [{ x: 1920, y: 0.1, dx: 50, dy: -40,
          note: { title: 'Stable Temps', label: 'Minor fluctuations before 1950' } }]
      },
      { label: 'Post-War Boom', endYear: 1990, interactive: false,
        annotation: [
          { x: 1960, y: 0.2, dx: 40, dy: -50, note: { title: 'Industrial Impact', label: 'Warming accelerates post-1950s' } },
          { x: 1975, y: 0.4, dx: 60, dy: 30, note: { title: '1970s Trend', label: 'Clear upward trend' } }
        ]
      },
      { label: '21st Century Crisis', endYear: 2023, interactive: true,
        annotation: [
          { x: 2010, y: 1.2, dx: -80, dy: -40, note: { title: 'Crisis Point', label: 'Unprecedented warming rates' } },
          { x: 2020, y: 1.4, dx: -60, dy: 30, note: { title: 'Record Years', label: 'Multiple record-breaking years' } }
        ]
      }
    ];

    // Annotation helper
    function annotate(items) {
      const ann = d3.annotation().type(d3.annotationLabel).annotations(items);
      svg.append('g').attr('class', 'annotation-group').call(ann);
    }

    // Draw scene by index
    function drawScene(idx) {
      const scene = scenes[idx];
      // Update UI
      d3.select('#sceneIndicator').text(`Scene ${idx+1} of ${scenes.length} – ${scene.label}`);
      d3.select('#prevBtn').property('disabled', idx === 0);
      d3.select('#nextBtn').property('disabled', idx === scenes.length - 1);
      d3.select('#interactiveNote').style('display', scene.interactive ? 'block' : 'none');

      // Filter data
      const filtered = data.filter(d => d.year <= scene.endYear);

      // Clear previous
      svg.selectAll('.line-seg, .dot, .annotation-group').remove();

      // Draw line segments
      filtered.forEach((d, i) => {
        if (i < filtered.length - 1) {
          svg.append('path')
            .datum([filtered[i], filtered[i + 1]])
            .attr('class', 'line-seg')
            .attr('d', lineGen)
            .style('stroke', color(filtered[i].year))
            .style('stroke-width', 2)
            .style('opacity', 0)
            .transition().delay(i * 5).duration(200).style('opacity', 1);
        }
      });

      // Interactive dots
      if (scene.interactive) {
        svg.selectAll('.dot')
          .data(filtered.filter((d, i) => i % 5 === 0))
          .enter().append('circle').attr('class', 'dot')
            .attr('cx', d => x(d.year))
            .attr('cy', d => y(d.temperature))
            .attr('r', 4)
            .style('fill', d => color(d.year))
            .style('stroke', '#fff')
            .style('stroke-width', 1)
          .on('mouseover', (e, d) => {
            tooltip.style('opacity', 1)
              .html(`Year: ${d.year}<br/>${d.temperature.toFixed(2)}°C`)
              .style('left', (e.pageX + 10) + 'px')
              .style('top', (e.pageY - 30) + 'px');
          })
          .on('mouseout', () => tooltip.style('opacity', 0));
      }

      // Add annotations
      annotate(scene.annotation.map(a => ({ x: x(a.x), y: y(a.y), dx: a.dx, dy: a.dy, note: a.note })));      
      currentScene = idx;
    }

    // Load & parse CSV, skipping first metadata line
    d3.text('data/GLB.Ts+dSST.csv').then(raw => {
      const rows = raw.split('\n');
      const header = rows[1];                   // "Year,Jan,...,J-D,..."
      const dataRows = rows.slice(2).filter(r => /^[0-9]{4},/.test(r));
      const csvText = [header, ...dataRows].join('\n');
      const parsed = d3.csvParse(csvText, d => ({
        year: +d.Year,
        temperature: +d['J-D']               // use J-D column for annual anomaly
      }));
      data = parsed;

      // Update scales
      x.domain(d3.extent(data, d => d.year));
      y.domain(d3.extent(data, d => d.temperature)).nice();
      color.domain(d3.extent(data, d => d.year));

      // Draw axes
      svg.append('g').attr('class', 'x axis')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d3.format('d')));
      svg.append('g').attr('class', 'y axis')
        .call(d3.axisLeft(y));
      svg.append('text').attr('class', 'axis-label')
        .attr('x', width / 2).attr('y', height + margin.bottom - 5)
        .style('text-anchor', 'middle').text('Year');
      svg.append('text').attr('class', 'axis-label')
        .attr('transform', 'rotate(-90)').attr('x', -height/2).attr('y', -margin.left + 15)
        .style('text-anchor', 'middle').text('Temperature Anomaly (°C)');

      // Initial scene
      drawScene(0);
    });

    // Navigation handlers
    d3.select('#nextBtn').on('click', () => { if (currentScene < scenes.length - 1) drawScene(currentScene + 1); });
    d3.select('#prevBtn').on('click', () => { if (currentScene > 0) drawScene(currentScene - 1); });
    d3.select(window).on('keydown', event => {
      if (event.key === 'ArrowRight') d3.select('#nextBtn').dispatch('click');
      if (event.key === 'ArrowLeft') d3.select('#prevBtn').dispatch('click');
    });
  </script>
</body>
</html>
